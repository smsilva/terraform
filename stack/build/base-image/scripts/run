#!/bin/sh
export TERRAFORM_COMMAND="$@"
export TERRAFORM_PLAN_FILE="/stack/output/terraform.plan"

/stack/loadconfig /stack/stack.conf
/stack/loadconfig /stack/backend.conf
. /stack/env.conf
/stack/create-auto-tfvars-file
/stack/show-debug-information

if [ "${TERRAFORM_COMMAND}" == "plan" ] || [ -z "${TERRAFORM_COMMAND}" ]; then
  terraform plan \
    -lock-timeout=300s \
    -out ${TERRAFORM_PLAN_FILE?}

  exit 0
fi

if [ "${TERRAFORM_COMMAND}" == "apply" ]; then
  terraform apply \
    -lock-timeout=300s \
    -auto-approve ${TERRAFORM_PLAN_FILE?}

  terraform apply \
     -auto-approve \
     -refresh-only

  exit 0
fi

terraform "$@"
