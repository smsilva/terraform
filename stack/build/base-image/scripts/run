#!/bin/sh
export TERRAFORM_COMMAND="$@"
export TERRAFORM_VERSION=$(terraform --version | head -1 | awk '{ print $2 }')
export TERRAFORM_PLAN_FILE="/stack/output/terraform.plan"

# Load Stack Settings
while read -r LINE; do
  export "${LINE}"
done < /stack/stack.conf

# Load Backend Settings
while read -r LINE; do
  export "${LINE}"
done < /stack/backend.conf

/stack/show-debug-information

cat <<EOF > terraform.auto.tfvars
environment_name="${ENVIRONMENT_NAME}"
EOF

if [ -n "${ENVIRONMENT_REGION}" ]; then
  echo "region=\"${ENVIRONMENT_REGION}\"" >> terraform.auto.tfvars
fi

if [ "${TERRAFORM_COMMAND}" == "plan" ] || [ -z "${TERRAFORM_COMMAND}" ]; then
  terraform plan \
    -lock-timeout=300s \
    -out ${TERRAFORM_PLAN_FILE?}

  exit 0
fi

if [ "${TERRAFORM_COMMAND}" == "apply" ]; then
  terraform apply \
    -lock-timeout=300s \
    -auto-approve ${TERRAFORM_PLAN_FILE?}

  terraform apply \
     -auto-approve \
     -refresh-only

  exit 0
fi

terraform "$@"
