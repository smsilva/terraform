#!/bin/bash
export PATH=../scripts/:${PATH}

VARIABLES_DIRECTORY="$1"
TARGET_DIRECTORY="$2"
TEMP_FILE="${HOME?}/.stack/env_var_temp.conf"

sudo rm -rf "${TARGET_DIRECTORY?}"
mkdir -p "${TARGET_DIRECTORY?}"

custom_image_name() {
  FILE_NAME=$(basename "$1")
  echo "${FILE_NAME%.tfvars}"
}

while read -r TFVARS_ABSOLUT_FILE_NAME; do
  CUSTOM_IMAGE_NAME=$(custom_image_name "${TFVARS_ABSOLUT_FILE_NAME?}")
  CUSTOM_IMAGE_DIRECTORY="${TARGET_DIRECTORY?}/${CUSTOM_IMAGE_NAME?}"
  CUSTOM_IMAGE_ENVIRONMENT_VARIABLE_FILE="${CUSTOM_IMAGE_DIRECTORY?}/build.conf"
  mkdir -p "${CUSTOM_IMAGE_DIRECTORY}"

  # Copy tfvars file
  cp "${TFVARS_ABSOLUT_FILE_NAME?}" "${CUSTOM_IMAGE_DIRECTORY?}/terraform.tfvars"

  # Retrieve some variables from tfvars file and export each one as an Environment Variable
  grep -E "^environment_name|^stack_name|^stack_version" "${TFVARS_ABSOLUT_FILE_NAME?}" > "${TEMP_FILE?}"
  loadconfig "${TEMP_FILE?}" > "${CUSTOM_IMAGE_ENVIRONMENT_VARIABLE_FILE}"
  source "${CUSTOM_IMAGE_ENVIRONMENT_VARIABLE_FILE}"

  # Evaluate Backend Configuration Template
  export BACKEND_KEY="${ENVIRONMENT_NAME?}"
  export BACKEND_STORAGE_ACCOUNT_NAME="${ARM_STORAGE_ACCOUNT_NAME?}"
  export BACKEND_CONTAINER_NAME="${BACKEND_CONTAINER_NAME-terraform}"
  envsubst < templates/backend.conf > "${CUSTOM_IMAGE_DIRECTORY?}/backend.conf"

  # Evaluate Dockerfile Template
  envsubst < templates/Dockerfile > "${CUSTOM_IMAGE_DIRECTORY?}/Dockerfile"

  # Evaluate Azure Resource Manager Template
  envsubst < templates/azurerm.conf > "${CUSTOM_IMAGE_DIRECTORY?}/azurerm.conf"

  # Log
  echo "${CUSTOM_IMAGE_DIRECTORY?} [image: ${STACK_NAME?}:${STACK_VERSION?}]"
done <<< "$(find "${VARIABLES_DIRECTORY?}" -type f -name "*.tfvars")"
